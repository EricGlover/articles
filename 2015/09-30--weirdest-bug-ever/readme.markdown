<sub>&#x1F6A8; <strong>Autogenerated!</strong> See <a href="https://github.com/ponyfoo/articles/tree/noindex/contributing.markdown"><code>contributing.markdown</code></a> for details. See also: <a href="https://ponyfoo.com/articles/weirdest-bug-ever">web version</a>.</sub>

<a href="https://ponyfoo.com/articles/weirdest-bug-ever"><div><img src="https://i.imgur.com/V812QXi.jpg" alt="SVG and the DOM, or &#x201C;The Weirdest Bug I&#x2019;ve Ever Encountered&#x201D;"></div></a>

<h1>SVG and the DOM, or &#x201C;The Weirdest Bug I&#x2019;ve Ever Encountered&#x201D;</h1>

<p><kbd>svg</kbd> <kbd>bug</kbd></p>

<blockquote><p>I wanted to take a step back from all of the ES6 articles that have been popping up on Pony Foo lately to talk about a bug I came across last week. As I mentioned &#x2026;</p></blockquote>

<div><p>I wanted to take a step back from all of the ES6 articles that have been popping up on Pony Foo lately to talk about a bug I came across last week. As I mentioned yesterday, the first thing I did during the <a href="https://ponyfoo.com/articles/redesign" aria-label="Pony Foo Gets a Face Lift">redesign</a> was to come up with an animated version of the logo, but some fringe events started to occur when I tried to embed it into the site.</p></div>

<div></div>

<div><p>For the record, here&#x2019;s the animation. If all is well with the world, you should be able to set it in motion yourself by hovering over the icon at the top of this page, but I&#x2019;m still adding the animation below &#x2013; for posterity.</p> <p><img src="https://i.imgur.com/oZRo9PN.gif" alt="The ponyfoo.com logo in all of its animated glory"></p> <p>I put together the logo on CodePen. I find CodePen to be extremely useful when doing this kind of thing, as I don&#x2019;t have to set up any live reloading stuff and I can just focus on the little thing I&#x2019;m trying to accomplish &#x2013; in this case, embellish a logo. <a href="https://twitter.com/nzgb/status/619344789616594944" target="_blank">Earlier</a> this year I had turned the logo into an SVG graphic, making for a <strong>much</strong> nicer favicon than I used to have. So I took that, I put it <a href="http://codepen.io/bevacqua/pen/EVZLLm?editors=110" target="_blank" aria-label="See it on CodePen">up on CodePen</a>, and added a bunch of styles to animate the logo on hover.</p> <p data-height="232" data-theme-id="9622" data-slug-hash="EVZLLm" data-default-tab="result" data-user="bevacqua" class="codepen">See the Pen <a href="http://codepen.io/bevacqua/pen/EVZLLm/">EVZLLm</a> by Nicolas Bevacqua (<a href="http://codepen.io/bevacqua">@bevacqua</a>) on <a href="http://codepen.io/">CodePen</a>.</p> <p>The styles are fairly simple. Each <em>&#x201C;pixel&#x201D;</em> in the logo is an SVG <code class="md-code md-code-inline">&lt;rect&gt;</code>. These have an SVG <code class="md-code md-code-inline">fill</code> color, and that&#x2019;s used to determine what color should be animated. The sweep effect is caused by the following bit of code. It adds 10 milliseconds to the total length of the animation, times the index in the DOM tree. That means the first pixel animates in full for <code class="md-code md-code-inline">710ms</code>, the second one takes <code class="md-code md-code-inline">720ms</code> to complete, and so on. It really is very simple, and I love how new patterns unfold as the animation goes on.</p> <pre class="md-code-block"><code class="md-code md-lang-stylus">for offset in (1..107)
  &amp;:nth-child({offset})
    animation-duration 0.7s + offset * 0.01
</code></pre> <p>Then I tried adding it to my site.</p></div>

<div><h2 id="using-an-img-tag">Using an <code class="md-code md-code-inline">&lt;img&gt;</code> tag</h2> <p>Specifically, in the header of the site. I saved the file as <code class="md-code md-code-inline">ponyfoo.svg</code> and placed it in my images directory. Then I updated my HTML markup with something like the code below. The fallback <code class="md-code md-code-inline">onerror</code> was a nice touch, I guess.</p> <pre class="md-code-block"><code class="md-code md-lang-xml"><span class="md-code-tag">&lt;<span class="md-code-title">a</span> <span class="md-code-attribute">href</span>=<span class="md-code-value">&apos;/&apos;</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">img</span> <span class="md-code-attribute">src</span>=<span class="md-code-value">&apos;/img/ponyfoo.svg&apos;</span> <span class="md-code-attribute"><mark class="md-mark md-code-mark">onerror</mark></span>=<span class="md-code-value">&apos;this.src=&quot;/img/ponyfoo.png&quot;&apos;</span><span class="md-code-value"></span> /&gt;</span>
<span class="md-code-tag">&lt;/<span class="md-code-title">a</span>&gt;</span>
</code></pre> <p>The problem with using an <code class="md-code md-code-inline">&lt;img&gt;</code> tag to embed SVG graphics in a site is that it completely ignores CSS. That approach was immediately out then, as I couldn&#x2019;t animate the logo on hover &#x2013; or at all &#x2013; with an <code class="md-code md-code-inline">&lt;img&gt;</code> tag. After that approach failed me, I tried an <code class="md-code md-code-inline">&lt;object&gt;</code> next.</p> <h2 id="using-an-object-tag">Using an <code class="md-code md-code-inline">&lt;object&gt;</code> tag</h2> <p>I know, what year is this? Anyways. Here&#x2019;s the HTML code I used.</p> <pre class="md-code-block"><code class="md-code md-lang-xml"><span class="md-code-tag">&lt;<span class="md-code-title">a</span> <span class="md-code-attribute">href</span>=<span class="md-code-value">&apos;/&apos;</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">object</span> <span class="md-code-attribute">data</span>=<span class="md-code-value">&apos;/img/ponyfoo.svg&apos;</span> <span class="md-code-attribute">type</span>=<span class="md-code-value">&apos;image/svg+xml&apos;</span>&gt;</span>
    <span class="md-code-tag">&lt;<span class="md-code-title">img</span> <span class="md-code-attribute">src</span>=<span class="md-code-value">&apos;/img/ponyfoo.png&apos;</span> /&gt;</span>
  <span class="md-code-tag">&lt;/<span class="md-code-title">object</span>&gt;</span>
<span class="md-code-tag">&lt;/<span class="md-code-title">a</span>&gt;</span>
</code></pre> <p>This one was even weirder. The link <strong>stopped working altogether</strong>, because the <code class="md-code md-code-inline">&lt;object&gt;</code> goes into obscure sandboxing mode. The CSS animation wouldn&#x2019;t work either, but I could <a href="https://css-tricks.com/using-svg/" target="_blank" aria-label="Using SVG as an &lt;object&gt; section, &apos;Using SVG on CSS-Tricks&apos;">place the CSS styles <em>inside</em></a> the SVG graphic, and then they worked on hover. Still, the link wasn&#x2019;t working either. I guess I could <a href="http://stackoverflow.com/a/19553517/389745" target="_blank" aria-label="Make an html svg object also a clickable link question on StackOverflow">add the link inside the SVG</a> as well! At this point the SVG was an utter mess.</p> <pre class="md-code-block"><code class="md-code md-lang-xml"><span class="md-code-tag">&lt;<span class="md-code-title">svg</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">style</span>&gt;</span><span>&lt;!<span class="md-code-tag">--</span> <span class="md-code-tag">lots</span> <span class="md-code-tag">of</span> <span class="md-code-tag">compiled</span> <span class="md-code-tag">css</span> <span class="md-code-tag">--</span>&gt;</span><span class="md-code-tag">&lt;/<span class="md-code-title">style</span>&gt;</span>
  <span class="md-code-comment">&lt;!-- all the rects --&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">a</span> <span class="md-code-attribute">xmlns</span>=<span class="md-code-value">&apos;http://www.w3.org/2000/svg&apos;</span> <span class="md-code-attribute">xlink:href</span>=<span class="md-code-value">&apos;/&apos;</span> <span class="md-code-attribute">xmlns:xlink</span>=<span class="md-code-value">&apos;http://www.w3.org/1999/xlink&apos;</span> <span class="md-code-attribute">target</span>=<span class="md-code-value">&apos;_top&apos;</span>&gt;</span>
    <span class="md-code-tag">&lt;<span class="md-code-title">rect</span> <span class="md-code-attribute">x</span>=<span class="md-code-value">&apos;0&apos;</span> <span class="md-code-attribute">y</span>=<span class="md-code-value">&apos;0&apos;</span> <span class="md-code-attribute">width</span>=<span class="md-code-value">&apos;100%&apos;</span> <span class="md-code-attribute">height</span>=<span class="md-code-value">&apos;100%&apos;</span> <span class="md-code-attribute">fill-opacity</span>=<span class="md-code-value">&apos;0&apos;</span> /&gt;</span>
  <span class="md-code-tag">&lt;/<span class="md-code-title">a</span>&gt;</span>
<span class="md-code-tag">&lt;/<span class="md-code-title">svg</span>&gt;</span>
</code></pre> <p>That worked &#x2013; kind of. It wasn&#x2019;t the prettiest of files, though. I hated the fact that I had to inline the entire CSS inside the SVG, and even the link. So un-DRY of you, SVG.</p> <blockquote class="twitter-tweet"><p>Ugh! Could SVG have any more interop issues w/ html? - &lt;img&gt; ignores css/animations - &lt;object&gt; ignores links, needs embedded css</p>&#x2014; Nicolas Bevacqua (@nzgb) <a href="https://twitter.com/nzgb/status/647325093891321856">September 25, 2015</a></blockquote> <p>Okay then, I decided to try one more and that&#x2019;s when it all went to hell.</p> <h2 id="using-an-svg-tag">Using an <code class="md-code md-code-inline">&lt;svg&gt;</code> tag</h2> <p>I decided that maybe using an inline <code class="md-code md-code-inline">&lt;svg&gt;</code> tag wouldn&#x2019;t be that bad. After all, this was the logo. It&#x2019;s a relatively small graphic, and then I could have the CSS lying around with all its other CSS rule pals. This time, the markup went like below. I included an <code class="md-code md-code-inline">&lt;image&gt;</code> tag as a <a href="https://twitter.com/jaffathecake/status/647328352664190976" target="_blank">clever hack</a> that provided a fallback for older browsers.</p> <pre class="md-code-block"><code class="md-code md-lang-xml"><span class="md-code-tag">&lt;<span class="md-code-title">a</span> <span class="md-code-attribute">href</span>=<span class="md-code-value">&apos;/&apos;</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">svg</span>&gt;</span>
    <span class="md-code-comment">&lt;!-- all the rects --&gt;</span>
    <mark class="md-mark md-code-mark"><span class="md-code-tag">&lt;<span class="md-code-title">image</span> <span class="md-code-attribute">src</span>=<span class="md-code-value">&apos;/img/ponyfoo.png&apos;</span>/&gt;</span></mark>
  <span class="md-code-tag">&lt;/<span class="md-code-title">svg</span>&gt;</span>
<span class="md-code-tag">&lt;/<span class="md-code-title">a</span>&gt;</span>
</code></pre> <p>This one was supposed to work great. You can find the full snippet of code <a href="https://gist.githubusercontent.com/bevacqua/07bf49036dcc534130b0/raw/e99b95fbf99bf5d70c6719090f8d2f2e5058c961/a.html" target="_blank">here</a>. If you paste that code into an HTML file and open it, it&#x2019;ll work in most browsers. If you host that same file in a Node.js server, and navigate to that page under <em>Google Chrome 45.0.2454</em>, the animation won&#x2019;t work.</p> <p>Let&#x2019;s recap to highlight how fringe all this is.</p> <ul> <li>It doesn&#x2019;t matter whether you set <code class="md-code md-code-inline">&lt;!doctype&gt;</code> or not, that&#x2019;s inferred</li> <li>The <a href="https://gist.githubusercontent.com/bevacqua/07bf49036dcc534130b0/raw/e99b95fbf99bf5d70c6719090f8d2f2e5058c961/a.html" target="_blank">snippet</a> works on all browsers when opened as a file</li> <li>The animation doesn&#x2019;t work on <em>Google Chrome 45.0.2454</em> when hosted on a server <a href="http://codepen.io/bevacqua/pen/QjdxgG?editors=100" target="_blank">(example in CodePen)</a></li> <li>The animation works if you remove the <code class="md-code md-code-inline">&lt;a&gt;</code> around the SVG</li> <li>The animation works if the snippet is opened as a file</li> <li>The animation works if <strong>you aren&#x2019;t logged into your Google Chrome profile</strong></li> <li>The animation works if you use Chrome Canary <em>(we didn&#x2019;t try older versions)</em></li> <li>It gets Google engineers to go <em>&#x201C;holy shit!&#x201D;</em></li> </ul> <blockquote class="twitter-tweet"><p><a href="https://twitter.com/nzgb">@nzgb</a> holy shit, it&apos;s working on one profile, but failing on another - same version of Chrome</p>&#x2014; Jake Archibald (@jaffathecake) <a href="https://twitter.com/jaffathecake/status/647458048991227904">September 25, 2015</a></blockquote> <p>For the record, I&#x2019;m <em>not bashing Google Chrome</em> here. I&#x2019;m just pointing at a very weird bug I came across and got pretty frustrated about. I guess this is one of those things Chris Heilmann talks about when he speaks of how we&#x2019;re failing the web.</p> <p>Granted, we <a href="https://ponyfoo.com/articles/fast-forwarding-the-web-platform" aria-label="Fast-forwarding the Web Platform on Pony Foo">may not</a> need a <a href="http://www.quirksmode.org/blog/archives/2015/07/stop_pushing_th.html" target="_blank" aria-label="Stop Pushing the Web Forward">moratorium</a> on web features &#x2013; but we do need this kind of primitives to be fixed. Basic stuff like styling a <code class="md-code md-code-inline">&lt;select&gt;</code> or an <code class="md-code md-code-inline">&lt;input type=&apos;check&apos;&gt;</code> <strong>shouldn&#x2019;t</strong> be an art form (as Chris points out). It <strong>should</strong> be really simple to embed SVG graphics in our websites. It should be easier to set up SSL.</p> <p>We can do better.</p></div>
