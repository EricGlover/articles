<sub>&#x1F6A8; <strong>Autogenerated!</strong> See <a href="https://github.com/ponyfoo/articles/tree/noindex/contributing.markdown"><code>contributing.markdown</code></a> for details. See also: <a href="https://ponyfoo.com/articles/backgroundsync">web version</a>.</sub>

<a href="https://ponyfoo.com/articles/backgroundsync"><div><img src="https://i.imgur.com/I51DTgu.jpg" alt="ServiceWorker: A Basic Guide to BackgroundSync"></div></a>

<h1>ServiceWorker: A Basic Guide to BackgroundSync</h1>

<p><kbd>serviceworker</kbd> <kbd>offline</kbd> <kbd>backgroundsync</kbd></p>

<blockquote><p>A simple guide to getting up and running using Background Sync and Service Workers. Background Sync is a new web API that lets you defer actions until the user has stable connectivity. This makes it great for ensuring that whatever the user wants to send, is actually sent.</p>
</blockquote>

<div><p>Picture the scene. You&#x2019;re using your mobile device to browse a website and book some important concert tickets. You&#x2019;ve have been eagerly awaiting this concert for months. You get right through to the checkout screen, enter your card details and hit submit. And then your flaky 3G connection drops. Screaming and pain ensues!</p></div>

<div><em>I&#x2019;m super eager to share the first of many guest posts that will be featured on Pony Foo! &#x1F389;</em><p></p> <p>When Dean came to me with the idea of writing an article on ServiceWorker, I was immediately thrilled with his proposal to write about BackgroundSync. I hadn&#x2019;t quite covered that area in previous <a href="https://ponyfoo.com/articles/tagged/serviceworker" target="_blank"><code class="md-code md-code-inline">serviceworker</code></a> articles, and he&#x2019;s put together a piece on what BackgroundSync is, how it works, and why it&#x2019;s useful.</p></div>

<div><p>I can&#x2019;t even begin to tell you the number of times I&#x2019;ve tried to submit a form or complete an action, only for my connection to drop and the browser to present me with an offline page. Up until now, we&#x2019;ve been unable to deal with situations like these, and it&#x2019;s a pretty crappy experience for our users. Fortunately, this is where Service Workers can come to the rescue. I&#x2019;ve previously blogged about using Service Workers to provide <a href="http://deanhume.com/Home/BlogPost/create-a-really--really-simple-offline-page-using-service-workers/10135" target="_blank">offline functionality</a> and dramatically speed up your load times using caching. While this is useful, there has been no way for the page to <em>actually</em> send something to the server without connectivity. <a href="https://github.com/WICG/BackgroundSync/blob/master/explainer.md" target="_blank">Background Sync</a> is the feature that has been built to handle just such a scenario.</p> <p><img src="https://dl.dropboxusercontent.com/u/909725/SW/background-sync-logo.jpg" alt="Background Sync Logo"></p></div>

<div><p>So what exactly is Background Sync? Well, it is a new web API that lets you defer actions until the user has stable connectivity. This makes it great for ensuring that whatever the user wants to send, is actually sent. The user can go offline and even close the browser, safe in the knowledge that their request will be sent when they regain connectivity.</p> <p>In this article, I am going to run through a simple example that shows you how to use Background Sync to ensure that your requests are queued even when the user is offline. We are going to take a look at a basic page that makes an HTTP request and will respond differently depending on whether on not the user is connected or not.</p> <p>In order to get started with this example, you&#x2019;ll need to have a basic understanding of Service Workers, but don&#x2019;t worry if you aren&#x2019;t familiar with them - there are some great resources online. I recommend checking out <a href="https://github.com/slightlyoff/ServiceWorker" target="_blank"><code class="md-code md-code-inline">slightlyoff/ServiceWorker</code></a> for more info.</p> <h2 id="getting-started">Getting Started</h2> <p>Imagine that you have the following HTML page. It&#x2019;s pretty basic, but it gives you the general idea.</p> <pre class="md-code-block"><code class="md-code md-lang-xml"><span class="md-code-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="md-code-tag">&lt;<span class="md-code-title">html</span>&gt;</span>
 <span class="md-code-tag">&lt;<span class="md-code-title">head</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">meta</span> <span class="md-code-attribute">charset</span>=<span class="md-code-value">&quot;UTF-8&quot;</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">title</span>&gt;</span>Home Page<span class="md-code-tag">&lt;/<span class="md-code-title">title</span>&gt;</span>
 <span class="md-code-tag">&lt;/<span class="md-code-title">head</span>&gt;</span>
 <span class="md-code-tag">&lt;<span class="md-code-title">body</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">div</span> <span class="md-code-attribute">id</span>=<span class="md-code-value">&quot;connectionStatus&quot;</span>&gt;</span><span class="md-code-tag">&lt;/<span class="md-code-title">div</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">p</span>&gt;</span>Click on the button below to make an HTTP request.<span class="md-code-tag">&lt;<span class="md-code-title">p</span>&gt;</span>
  <span class="md-code-tag">&lt;<span class="md-code-title">button</span> <span class="md-code-attribute">id</span>=<span class="md-code-value">&quot;requestButton&quot;</span>&gt;</span>Make an HTTP request - do it!<span class="md-code-tag">&lt;/<span class="md-code-title">button</span>&gt;</span>
 <span class="md-code-tag">&lt;/<span class="md-code-title">body</span>&gt;</span>
<span class="md-code-tag">&lt;/<span class="md-code-title">html</span>&gt;</span>
</code></pre> <p>The HTML above shows a simple button that will make an HTTP request for an image when clicked. If the webpage has a connection, the HTTP request should go through without any issues. However if there is no connection, the HTTP request will be queued and synced as soon as the user has a connection again.</p> <p>In order to use Background Sync, we are going need to create a Service Worker to unlock this functionality. Let&#x2019;s start off by registering the Service Worker in the page that we have just created. Add the following code to your HTML.</p> <pre class="md-code-block"><code class="md-code md-lang-javascript"><span class="md-code-keyword">if</span> (<span class="md-code-string">&apos;serviceWorker&apos;</span> <span class="md-code-keyword">in</span> navigator) {
  navigator.serviceWorker
    .register(<span class="md-code-string">&apos;./service-worker.js&apos;</span>)
    .then(registration =&gt; navigator.serviceWorker.ready)
    .then(registration =&gt; { <span class="md-code-comment">// register sync</span>
      <span class="md-code-built_in">document</span>.getElementById(<span class="md-code-string">&apos;requestButton&apos;</span>).addEventListener(<span class="md-code-string">&apos;click&apos;</span>, () =&gt; {
        registration.sync<mark class="md-mark md-code-mark">.register(<span class="md-code-string">&apos;image-fetch&apos;</span>)</mark>.then(() =&gt; {
            <span class="md-code-built_in">console</span>.log(<span class="md-code-string">&apos;Sync registered&apos;</span>);
        });
      });
    });
} <span class="md-code-keyword">else</span> {
  <span class="md-code-built_in">document</span>.getElementById(<span class="md-code-string">&apos;requestButton&apos;</span>).addEventListener(<span class="md-code-string">&apos;click&apos;</span>, () =&gt; {
    <span class="md-code-built_in">console</span>.log(<span class="md-code-string">&apos;Fallback to fetch the image as usual&apos;</span>);
  });
}

</code></pre> <p>The code above might look a little hairy at first, but let&#x2019;s break it down. First, I am doing a simple check to see if the browser supports Service Workers. If it does, I then register a file called <strong>service-worker.js</strong>. This file will contain the Service Worker code with all of the Background Sync magic. We are going to create this shortly. You might also notice that if the browser doesn&#x2019;t support Service Workers, the code simply falls back and will make an HTTP request as normal without using Background Sync.</p> <p>Next, if the registration is successful, I am adding a <em>click</em> event to the button and registering a sync called <em>image-fetch</em>. This is just a simple string that I&#x2019;ve named to help me recognize this event. You can think of these sync names a simple tags for different actions - you can have as many as you want!</p> <h2 id="the-service-worker">The Service Worker</h2> <p>Next, we need to create the Service Worker file and call it &#x2018;service-worker.js&#x2019;. We are going to use this Service Worker to make an HTTP request for a simple image and return it if successful.</p> <p>Once I&#x2019;ve created the <em>service-worker.js</em> file, I&#x2019;ll add the following code:</p> <pre class="md-code-block"><code class="md-code md-lang-javascript">self.addEventListener(<span class="md-code-string">&apos;sync&apos;</span>, <span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">(event)</span> </span>{
  <span class="md-code-keyword">if</span> (event.tag === <mark class="md-mark md-code-mark"><span class="md-code-string">&apos;image-fetch&apos;</span></mark>) {
    event.waitUntil(fetchDogImage());
  }
});
</code></pre> <p>The code above creates an event that listens out for the <em>sync</em> event. If their page has a connection, it will try and fetch the image, and if it fulfills, the sync is complete. If it fails, another sync will be scheduled to retry. Retry syncs also wait for connectivity, and employ an exponential back-off.</p> <p>Next, I need to add a function that fetches the image of the dog.</p> <pre class="md-code-block"><code class="md-code md-lang-javascript">  <span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-title">fetchDogImage</span> <span class="md-code-params">()</span> </span>{
    fetch(<span class="md-code-string">&apos;./doge.png&apos;</span>)
      .then(<span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">(response)</span> </span>{
        <span class="md-code-keyword">return</span> response;
      })
      .then(<span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">(text)</span> </span>{
        <span class="md-code-built_in">console</span>.log(<span class="md-code-string">&apos;Request successful&apos;</span>, text);
      })
      .catch(<span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">(error)</span> </span>{
        <span class="md-code-built_in">console</span>.log(<span class="md-code-string">&apos;Request failed&apos;</span>, error);
      });
  }
</code></pre> <p>The code above uses the Fetch API to retrieve an image from the server. It will return a promise indicating if it was successful or if it failed with the HTTP response.</p> <p>And that&#x2019;s it! You are now able to use BackgroundSync to enable offline actions that will queue depending on connectivity.</p> <h2 id="testing-in-the-wild">Testing in the wild</h2> <p>Now that you have your page ready to sync events, you can test it in action. If you&#x2019;d like to see this example in action, I&#x2019;ve created a GitHub page that you can use to experiment with. Head over to <a href="https://deanhume.github.io/Service-Workers-BackgroundSync/" target="_blank">the demo page</a> to find out more.</p> <p>When you have an active connection, you should see network requests going through in the <strong>Network</strong> tab of your developer tools.</p> <p><img alt="BackgroundSync Online Service Workers" class="" src="https://dl.dropboxusercontent.com/u/909725/SW/backgroundsync-online-service-workers.jpg"></p> <p>If you aren&#x2019;t connected to the internet, your request will be synced when the user regains connectivity. In order to test this, I simply disabled the wifi, made an HTTP request and then re-enabled the wifi.</p> <p><img alt="BackgroundSync Offline Service Workers" class="" src="https://dl.dropboxusercontent.com/u/909725/SW/backgroundsync-offline-service-workers.jpg"></p> <p>As soon as you re-enable the wifi connection, you should see the HTTP request appear in the network tab as normal.</p> <p>I did notice a few things with the behavior of the sync when I was testing. Firstly, the tag name of the sync should be unique for a given sync. If you register for a sync using the same tag as a pending sync, it will combine with the existing sync. Which means that in the case of this example, if you register for a &#x201C;image-fetch&#x201D; sync every time the user clicks the button, you will only receive one sync when they connect again. If you want 5 separate sync events, you&#x2019;ll need to use unique tags.</p> <h2 id="notifying-the-user">Notifying the user</h2> <p>The example that we&#x2019;ve run through isn&#x2019;t very pretty and doesn&#x2019;t provide the user with much feedback. It would be a much better experience if the user received feedback about the current state of their connectivity while viewing the page.</p> <p>Using a clever bit of code, I can listen out for any changes in the user connectivity.</p> <pre class="md-code-block"><code class="md-code md-lang-javascript"><span class="md-code-comment">// Connection Status</span>
<span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-title">isOnline</span> <span class="md-code-params">()</span> </span>{
  <span class="md-code-keyword">var</span> connectionStatus = <span class="md-code-built_in">document</span>.getElementById(<span class="md-code-string">&apos;connectionStatus&apos;</span>);

  <span class="md-code-keyword">if</span> (navigator.onLine){
    connectionStatus.innerHTML = <span class="md-code-string">&apos;You are currently online!&apos;</span>;
  } <span class="md-code-keyword">else</span> {
    connectionStatus.innerHTML = <span class="md-code-string">&apos;You are currently offline. Any requests made will be queued and synced as soon as you are connected again.&apos;</span>;
  }
}

<span class="md-code-built_in">window</span>.addEventListener(<span class="md-code-string">&apos;online&apos;</span>, isOnline);
<span class="md-code-built_in">window</span>.addEventListener(<span class="md-code-string">&apos;offline&apos;</span>, isOnline);
isOnline();
</code></pre> <p>In the code above, I&#x2019;ve added an event listener on the window object to listen for connectivity changes. As soon as this connectivity state changes, I&#x2019;m updating the page with a notification message depending on the result. By adding the above code to our web page, we can update the user every time their connection state changes.</p> <p>The code above isn&#x2019;t bulletproof - <a href="https://developer.mozilla.org/en-US/docs/Web/API/NavigatorOnLine/onLine" target="_blank">navigator.onLine</a> only knows if the user can&#x2019;t connect to a LAN or router - it doesn&#x2019;t know if the the user can actually connect to the internet. That said, I still think it can be useful to provide the user with some feedback when they are trying to perform an action if they aren&#x2019;t connected!</p> <h2 id="the-future">The Future</h2> <p>There is still more to come for Background Sync! The team working on Background Sync are currently working on a <a href="https://developers.google.com/web/updates/2015/12/background-sync?hl=en#the-future" target="_blank">Periodic Background Sync</a>. This will allow you to request a &#x201C;periodicsync&#x201D; event that will be restricted by time, battery state and network state. The API is still in design, but it might look a little something like the code below:</p> <pre class="md-code-block"><code class="md-code md-lang-javascript">
navigator.serviceWorker.ready.then(<span class="md-code-function"><span class="md-code-keyword">function</span><span class="md-code-params">(registration)</span> </span>{
  registration.periodicSync.register({
    tag: <span class="md-code-string">&apos;get-latest-news&apos;</span>,         <span class="md-code-comment">// default: &apos;&apos;</span>
    minPeriod: <span class="md-code-number">12</span> * <span class="md-code-number">60</span> * <span class="md-code-number">60</span> * <span class="md-code-number">1000</span>, <span class="md-code-comment">// default: 0</span>
    powerState: <span class="md-code-string">&apos;avoid-draining&apos;</span>,   <span class="md-code-comment">// default: &apos;auto&apos;</span>
    networkState: <span class="md-code-string">&apos;avoid-cellular&apos;</span>  <span class="md-code-comment">// default: &apos;online&apos;</span>
  }).then(<span class="md-code-function"><span class="md-code-keyword">function</span><span class="md-code-params">(periodicSyncReg)</span> </span>{
    <span class="md-code-comment">// success</span>
  }, <span class="md-code-function"><span class="md-code-keyword">function</span><span class="md-code-params">()</span> </span>{
    <span class="md-code-comment">// failure</span>
  })
});

</code></pre> <p>The code above is pretty similar to a standard Background Sync, except that it has a few more parameters. The <strong>minPeriod</strong> is the the minimum time between successful sync events, <strong>powerState</strong> can be used to only sync when the battery is charging, and <strong>networkState</strong> gives you control over whether you want to sync over wifi versus a cellular connection. Very cool!</p> <p>The great thing about periodic sync&#x2019;s is that they don&#x2019;t require any server configuration, and allow the browser to optimize when they fire to be most-helpful and least-disruptive to the user. All this can be done on the client without any server configuration! I can already think of a load of powerful uses for this feature.</p> <p>The API is still a work in progress, but if you&#x2019;d like to keep up to date with the latest changes, I recommend keeping a close eye on the <a href="https://github.com/WICG/BackgroundSync/blob/master/explainer.md#periodic-synchronization-in-design" target="_blank">WICG Background Sync Spec</a>.</p> <h2 id="summary">Summary</h2> <p>As a user, not being able to perform an action when you have no connectivity can be extremely frustrating. Fortunately, the functionality that Background Sync brings is a game changer. I am excited about the awesome possibilities that they bring to the web.</p> <p>If you&#x2019;d like to see a working example of this article in action, please head over to <a href="https://deanhume.github.io/Service-Workers-BackgroundSync/" target="_blank">the demo page</a>. All of the code behind this is available at <a href="https://github.com/deanhume/Service-Workers-BackgroundSync" target="_blank"><code class="md-code md-code-inline">deanhume/Service-Workers-BackgroundSync</code></a>.</p></div>
