<h1>The Angular Way</h1>

<p><kbd>angularjs</kbd> <kbd>front-end</kbd> <kbd>best-practices</kbd> <kbd>app-press</kbd></p>

<blockquote><p>For the past few months I&#x2019;ve been sailing around the world of Angular. Today I can hardly imagine myself doing day to day coding on a large front-end web &#x2026;</p></blockquote>

<div><p>For the past few months I&#x2019;ve been sailing around the world of Angular. Today I can hardly imagine myself doing day to day coding on a large front-end web application without <em>some kind</em> of data binding framework, such as <a href="http://angularjs.org/" target="_blank">Angular.js</a>, <a href="http://backbonejs.org/" target="_blank">Backbone.js</a>, and <a href="http://underscorejs.org/" target="_blank">friends</a>; and I can&#x2019;t believe I&#x2019;ve done so in the past.</p></div>

<div></div>

<div><p>I might however be <em>a bit biased</em>, considering the application I&#x2019;m working on is a <strong>PhotoShop</strong>esque editor in the browser, which presents the same data in <em>radically different</em> ways.</p> <ul> <li>Layers are presented graphically, taking up large portions of the screen. They are also listed in a panel where you can delete them.</li> <li>When you select a layer it gets the typical dashed line around its edges, and it also gets highlighted in the list view.</li> <li>Similarly, properties like the dimensions of a layer show up both in a panel and define their size upon the canvas.</li> <li>The panels I&#x2019;ve mentioned can be dragged around, collapsed, and closed.</li> </ul></div>

<div><p>This kind of interaction, data binding, and view synchronization would be easily be a <strong>maintenance nightmare</strong> if it wasn&#x2019;t for a framework such as Angular. Being able to update a model in one place, and have Angular update all relevant views almost feels like cheating. Adding, removing, or moving a layer is just a matter of changing an object. <code class="md-code md-code-inline">layer.x += 10</code>, done. There&#x2019;s no need to invalidate the view by hand, or to manually update each instance of the layer in the DOM. Or to even interact with the DOM, for that matter.</p> <p>Angular enabled us to go places we wouldn&#x2019;t ever have dreamt of, such as setting up a bunch of keyboard shortcuts that are enabled based on the current context of the application. For example, text editing shortcuts, such as <kbd>&#x2318;</kbd> <kbd>B</kbd> to toggle <strong>bold</strong> text, are just enabled when we&#x2019;re editing a text layer.</p> <p><a href="https://i.imgur.com/I1ZDYeO.png" target="_blank" aria-label="Click to enlarge"><img alt="app-press-shortcuts.png" class="" src="https://i.imgur.com/I1ZDYeO.png"></a></p> <p>Similarly, we tacked a description onto these shortcuts (which are registered through a <em>service</em> we created), and we are then able to show a list of shortcuts, along with their descriptions, in a handy cheat sheet. Furthermore, we wrote a <em>directive</em> which enables us to bind individual DOM elements with their keyboard shortcut counterparts, showing a tooltip when you hover over them for a little while, letting you know a keyboard shortcut is available, too.</p> <blockquote> <p>Angular enabled us to go places we wouldn&#x2019;t ever have dreamt of.</p> </blockquote> <p>Honestly, it&#x2019;s as if we weren&#x2019;t writing a web application anymore. The web is just the medium. As we improve our understanding of Angular, the code gets more modular, more self-contained, and yet&#x2026; more inter-connected. It is simply becoming <strong>more Angular</strong>.</p> <p>And by Angular I mean the highly interactive rich application development philosophy behind Angular.js, the same one that&#x2019;s enabled us to develop a piece of software that I wouldn&#x2019;t have thought possible a while back.</p> <p><a href="https://i.imgur.com/RSqiAkS.png" target="_blank" aria-label="Click to enlarge"><img alt="app-press-canvas.png" class="" src="https://i.imgur.com/RSqiAkS.png"></a></p> <p>We were even able to develop a full-fledged history panel that updates the DOM to the currently selected point in history, and <em>it performs well, too</em>! Seeing the data binding capabilities of Angular update every small detail in your view work flawlessly as you go back and forth in the history panel is inspiring, to say the least.</p> <blockquote> <p>It wasn&#x2019;t always so easy, the code-base used to be an uncontrollable mess.</p> </blockquote> <p>Indeed, in the last few weeks we&#x2019;ve been updating and re-writing the overall architecture of our front-end. Before we took up this re-write, looking to update Angular to <a href="https://github.com/angular/angular.js/tree/v1.2.0rc1" target="_blank" aria-label="Angular.js v1.2.0 RC 1">edge</a>, all the way from <a href="https://github.com/angular/angular.js/tree/v0.10.6" target="_blank" aria-label="Angular.js v0.10.6">0.10.6</a>. That&#x2019;s a pretty long way to go, if you look at the <a href="https://github.com/angular/angular.js/blob/v1.2.0rc1/CHANGELOG.md#0106-bubblewrap-cape-2012-01-17" target="_blank" aria-label="Angular.js change log, starting at v0.10.6">change log</a>.</p> <p>Going through this refactoring, we went from doing Angular <em>the wrong way</em>, to doing Angular <em>the Angular way</em>.</p> <p>The wrong way, in our case, encompassed quite a few issues we had to work through before getting to the lovable state our code-base is in at the moment.</p> <h3 id="controllers-declared-on-the-global-scope">Controllers declared on the global scope</h3> <p>This one is, sadly, pretty common amongst folks who&#x2019;ve been using Angular since the early days. If you&#x2019;re familiar with Angular, you might be familiar with this pattern, too.</p> <pre class="md-code-block"><code class="md-code md-lang-javascript">// winds up on window.LoginCtrl ...
var LoginCtrl = function ($scope, dep1, dep2) {
    // scope defaults
};

LoginCtrl.prototype.resetPassword = function () {
    // reset password button click handler  
};

// more on this one later
LoginCtrl.$inject = [&apos;$scope&apos;, dep1&apos;, &apos;dep2&apos;];
</code></pre> <p>That kind of file isn&#x2019;t wrapped in a closure, either, meaning anything declared on the root scope goes to the global <code class="md-code md-code-inline">window</code> object, yuck. The Angular way to do that is to use the <a href="http://docs.angularjs.org/guide/module" target="_blank" aria-label="Angular.js Modules">module API</a> they provide. But, as you can see, even in the documentation the <em>recommended setup</em> is still outdated and suggests you <strong>use the global scope mercilessly</strong>:</p> <blockquote> <p>Do this, and <strong>wonderful things</strong> will happen to you!</p> <pre class="md-code-block"><code class="md-code">// A Controller for your app
var XmplController = function($scope, greeter, user) {
  $scope.greeting = greeter.greet(user.name);
}
</code></pre> <p><em>&#x2013; the Angular.js documentation</em></p> </blockquote> <p>Using modules allows us to rewrite controllers in the following way:</p> <pre class="md-code-block"><code class="md-code md-lang-javascript">angular.module(<span class="md-code-string">&apos;myApp&apos;</span>).controller(<span class="md-code-string">&apos;loginCtrl&apos;</span>, [
    <span class="md-code-string">&apos;$scope&apos;</span>, <span class="md-code-string">&apos;dep1&apos;</span>, <span class="md-code-string">&apos;dep2&apos;</span>,
    <span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">($scope, dep1, dep2)</span> </span>{
<span class="md-code-pi">        &apos;use strict&apos;</span>;

        <span class="md-code-comment">// scope defaults</span>

        $scope.resetPassword = <span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">()</span> </span>{
            <span class="md-code-comment">// reset password button click handler </span>
        };
    }
]);
</code></pre> <p>The beauty I find in the way Angular approaches controllers, is that you you need the controller <code class="md-code md-code-inline">function</code> anyways, because that&#x2019;s used to inject the dependencies required by the controller, and it provides a new scope, strapping us from the need to wrap all of our script files in <em>self-invoking function expressions</em> like <code class="md-code md-code-inline">(function(){})()</code>.</p> <h3 id="dependency-inject-ion">Dependency <code class="md-code md-code-inline">$inject</code>ion</h3> <p>You might&#x2019;ve noticed that in the earliest example, dependencies are injected using <code class="md-code md-code-inline">$inject</code>. Most of the module API, on the other hand, allows you to pass either a <code class="md-code md-code-inline">function</code>, or an <code class="md-code md-code-inline">Array</code>, containing the list of dependencies, followed by the <code class="md-code md-code-inline">function</code> that depends on those. This is <em>the one thing</em> that I don&#x2019;t like in Angular, and it&#x2019;s probably the documentation&#x2019;s fault. Most of the examples in the documentation are treated as if you don&#x2019;t really need the <code class="md-code md-code-inline">Array</code> form; but the thing is, you do. If you minify your code using a minifier, without running <a href="https://github.com/btford/ngmin" target="_blank" aria-label="ngmin application pre-minifier">ngmin</a> first, you&#x2019;re going to have a bad time.</p> <p>Since you didn&#x2019;t explicitly declare your dependencies using the array form <code class="md-code md-code-inline">[&apos;$scope&apos;,...]</code>, your clean-looking function arguments are going to get minified to something like <code class="md-code md-code-inline">b,c,d,e</code>, effectively killing Angular&#x2019;s dependency injection capabilities. I consider this to be a gross mistake in the way they built the framework, in a similar way to my reasoning behind <a href="https://ponyfoo.com/2013/05/13/the-web-wars" aria-label="The Web Wars">strongly disliking Require.js</a> and their troubling AMD modules.</p> <blockquote> <p>If it&#x2019;s not going to work in production, what good is it for?</p> </blockquote> <p>My fundamental problem with this kind of behavior is that they have code in their framework that is dead as soon as you go in production. That&#x2019;s fine for utilities like <code class="md-code md-code-inline">console</code>, and error reporting, which are <em>useful</em> during development, and have uses in production. It doesn&#x2019;t make any sense in syntactic sugar that just works during development.</p> <p>These things infuriate me, but <em>enough ranting</em>. Talking of dollar signs&#x2026;</p> <h3 id="cutting-down-on-the-jquery-proliferation">Cutting down on the jQuery proliferation</h3> <p>Going in, the application was &#x201C;kind of Angular&#x201D;, in that it was just wrapped in Angular, but most DOM interaction happened through jQuery, rendering Angular pretty much moot.</p> <blockquote> <p>If I were to write an Angular.js application from scratch today, I wouldn&#x2019;t include jQuery right away. Forcing myself to use <a href="http://docs.angularjs.org/api/angular.element" target="_blank" aria-label="Angular.js angular.element API">angular.element</a> instead.</p> </blockquote> <p>The <code class="md-code md-code-inline">angular.element</code> API wraps <code class="md-code md-code-inline">jQuery</code> if it&#x2019;s present, and it alternatively provides the Angular team&#x2019;s implementation of jQuery&#x2019;s API, called <a href="https://github.com/angular/angular.js/blob/master/src/jqLite.js" target="_blank" aria-label="Angular.js jqLite source">jqLite</a>. It&#x2019;s not that jQuery is evil, or that we need yet another implementation that somewhat reflects their API. It&#x2019;s just that using jQuery isn&#x2019;t very Angular.</p> <p>Lets look at a concrete, and dumb, example. This uses jQuery to do class manipulation on the element where the controller has been declared.</p> <pre class="md-code-block"><code class="md-code md-lang-css">div.foo(ng-controller=&apos;fooCtrl&apos;)
</code></pre> <pre class="md-code-block"><code class="md-code md-lang-javascript">angular.module(<span class="md-code-string">&apos;foo&apos;</span>).controller(<span class="md-code-string">&apos;fooCtrl&apos;</span>, <span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">($scope)</span> </span>{
    $(<span class="md-code-string">&apos;.foo&apos;</span>).addClass(<span class="md-code-string">&apos;foo-init&apos;</span>);

    $scope.$watch(<span class="md-code-string">&apos;something&apos;</span>, <span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">()</span> </span>{
        $(<span class="md-code-string">&apos;.foo&apos;</span>).toggleClass(<span class="md-code-string">&apos;foo-something-else&apos;</span>);
    });
});
</code></pre> <p>However, we could be using Angular the way we&#x2019;re supposed to, instead.</p> <pre class="md-code-block"><code class="md-code md-lang-javascript">angular.module(<span class="md-code-string">&apos;foo&apos;</span>).controller(<span class="md-code-string">&apos;fooCtrl&apos;</span>, <span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">($scope, $element)</span> </span>{
    $element.addClass(<span class="md-code-string">&apos;foo-init&apos;</span>);

    $scope.$watch(<span class="md-code-string">&apos;something&apos;</span>, <span class="md-code-function"><span class="md-code-keyword">function</span> <span class="md-code-params">()</span> </span>{
        $element.toggleClass(<span class="md-code-string">&apos;foo-something-else&apos;</span>);
    });
});
</code></pre> <p>The bottom line is you shouldn&#x2019;t be manipulating the DOM (changing attributes, adding event listeners) directly, or through jQuery. You should be <a href="http://amitgharat.wordpress.com/2013/06/08/the-hitchhikers-guide-to-the-directive/" target="_blank" aria-label="The Hitchhiker&apos;s Guide to the Directive">using directives</a>, instead. That&#x2019;s an excellent article, go read it.</p> <p>If you&#x2019;re still jQuery-lized, there&#x2019;s lots of articles you could read, such as this <a href="http://amitgharat.wordpress.com/2013/06/22/migration-guide-for-jquery-developers/" target="_blank" aria-label="Migration Guide for jQuery Developers">migration guide</a>, and my article on <a href="http://blog.ponyfoo.com/2013/07/09/getting-over-jquery" target="_blank" aria-label="Getting Over jQuery">critically thinking</a> about whether to use jQuery.</p> <p>I won&#x2019;t sit here and claim we&#x2019;ve managed to remove jQuery altogether. We have other, more important goals in place, such as releasing the product. It was still worthwhile to remove as much jQuery spam as possible. Doing so simplified every controller we went through, we created directives that manipulate the DOM, and use <code class="md-code md-code-inline">angular.element</code>, even if it just maps to jQuery today.</p> <p>We have a dependency on the <em>oh-so-hideous</em> <a href="http://jqueryui.com/" target="_blank" aria-label="jQuery UI">jQuery UI</a> which makes me sick. We&#x2019;re clearly not using it just for the sake of dialogs, we have directives for that. But dragging, drag and drop, and in particular: being able to drag something and drop it in a sorted list, is just something that involves a lot of work if you&#x2019;re not using jQuery UI, there is no real alternative. The drag and drop problem has been solved, we could <em>(and probably should)</em> be using <a href="https://github.com/btford/angular-dragon-drop" target="_blank" aria-label="btford/angular-dragon-drop on GitHub">angular-dragon-drop</a>, which is a really simple drag and drop implementation. <a href="https://github.com/angular-ui/ui-sortable" target="_blank" aria-label="angular-ui-sortable on GitHub">Sortable</a> on the other hand, just depends on jQuery UI.</p> <h3 id="organizing-a-code-base">Organizing a code base</h3> <p>Another illness we had to deal with during our migration, was that <strong>the entire code-base was crammed together in a single large file</strong>. This file contained all the controllers, all services, directives, and code specific to each controller. I made it a point to break it down so that we had exactly one file per component. Right now, we have very few files with more than one component, and most of those happened because a directive used a service to share its data with the outside world.</p> <p>Although unrelated to Angular, we also modularized our stylesheets. We added a two letter prefix to every class name we use in our code. This prefix represents the component the class belonged to. <code class="md-code md-code-inline">pn-</code>, for example, represents classes that style the panels. <code class="md-code md-code-inline">ly-</code> for layers, and so on. The immediate benefit this provides is that you don&#x2019;t have to think about class names anymore. Because you&#x2019;re namespacing them, it becomes much harder for you to accidentally re-use a class name. Another benefit is reduced nesting, we used to have selectors such as <code class="md-code md-code-inline">#layoutEditor div.layer .handle div</code>, which now might be <code class="md-code md-code-inline">.ly-handle-content</code>. The deepest &#x201C;nesting&#x201D; we have now only occurs on overloaded selectors such as <code class="md-code md-code-inline">.fo-bar[disabled]:hover</code>, or at worst, something like <code class="md-code md-code-inline">.fo-bar .br-baz</code>.</p> <p>A few rules we laid out for this CSS class naming style were:</p> <ul> <li>Two characters to describe the component name. <code class="md-code md-code-inline">ly-</code>, <code class="md-code md-code-inline">dd-</code>, <code class="md-code md-code-inline">dg-</code>, etc.</li> <li>Instead of nesting classes such as <code class="md-code md-code-inline">.ly-foo .bar</code>, we gave <code class="md-code md-code-inline">.bar</code> a more appropriate <code class="md-code md-code-inline">.ly-foo-bar</code> name</li> <li>Avoid styling tags directly, use classes for everything. This reduces confusion and improves your ability to use semantic markup.</li> <li>Never use an ID in CSS.</li> </ul> <blockquote> <p>After implementing this component-oriented CSS declaration approach, I have a hard time thinking of going back to doing it &#x201C;the class soup way&#x201D;.</p> </blockquote> <p>Angular forces you to write good code, but on a deeper level than that, it forces you to think. A while later, it will either feel like a server-side implementation, or it&#x2019;ll become an unbearable hack-fest that you won&#x2019;t be able to stand on. <em>The choice is up to you.</em></p> <h3 id="a-piece-of-heaven">A Piece of Heaven</h3> <p>Let&#x2019;s decompose one of the pieces of our application, the layers.</p> <pre class="md-code-block"><code class="md-code md-lang-css">div.cv-layer(
    ng-repeat=&quot;layer in page.layers | reverse&quot;,
    ap-layer,
    ng-mousedown=&quot;selectLayer(layer.id)&quot;,
    ng-mouseup=&quot;selectLayer(layer.id)&quot;,
    ng-dblclick=&quot;doubleClickLayer(layer)&quot;,
    ng-hide=&quot;layer.invisible&quot;
)
</code></pre> <p>Here, we&#x2019;re using the <code class="md-code md-code-inline">cv-layer</code> class, given that the element is part of the <em>canvas</em> component (the canvas is where our layers are drawn to, not to be confused with an HTML5 <code class="md-code md-code-inline">canvas</code>). We&#x2019;re then using the <a href="http://docs.angularjs.org/api/ng.directive:ngRepeat" target="_blank" aria-label="Angular.js ngRepeat directive">ngRepeat</a> directive to create one of these elements per layer, in a <code class="md-code md-code-inline">foreach</code> kind of fashion. It is passed through a <code class="md-code md-code-inline">reverse</code> <a href="http://docs.angularjs.org/api/ng.filter:filter" target="_blank" aria-label="Angular.js filters">filter</a> we wrote, so that the last layer is visually on top. The <strong>apLayer</strong> directive is tasked with actually rendering the layer, whether it&#x2019;s an image, some text, HTML, or something else. The event directives (<code class="md-code md-code-inline">ng-mousedown</code>, <code class="md-code md-code-inline">ng-mouseup</code>, <code class="md-code md-code-inline">ng-dblclick</code>) simply delegate the event to our <em>layer selection service</em>, which handles it from there. Lastly, <code class="md-code md-code-inline">ngHide</code> doesn&#x2019;t really need a lot of explaining.</p> <p>That&#x2019;s a <strong>huge amount of functionality</strong>, and Angular manages to make it look simple with readable HTML that sort of tells you what&#x2019;s going on. Furthermore, it allows you to separate the different concerns allowing you to write concise pieces of code that don&#x2019;t try to do everything at once. In summary, it reduces complexity, making the complex, simple. And the &#x201C;hard to even fathom&#x201D;, possible.</p> <p>Expect more posts about writing Angular code in the future. Particularly, I&#x2019;m interested in discussing the corner-cases I ran into while upgrading our codebase, how we solved some, and how we worked around the rest.</p></div>
